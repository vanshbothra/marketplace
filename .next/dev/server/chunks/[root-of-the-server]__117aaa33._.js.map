{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/vanshbothra/Documents/project/marketplace/src/proxy.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport type { NextRequest } from 'next/server';\n\nconst BACKEND_URL = process.env.BACKEND_URL || \"https://backend.ashokamarketplace.tech\";\n\nexport default async function middleware(request: NextRequest) {\n    const { pathname } = request.nextUrl;\n\n    // Public routes that don't require authentication\n    const publicRoutes = ['/auth/signin', '/api/auth'];\n    const isPublicRoute = publicRoutes.some(route => pathname.startsWith(route));\n\n    if (isPublicRoute) {\n        return NextResponse.next();\n    }\n\n    // Check authentication with backend\n    try {\n        const response = await fetch(`${BACKEND_URL}/auth/browser/me`, {\n            method: 'GET',\n            headers: {\n                'Cookie': request.headers.get('cookie') || '',\n            },\n            credentials: 'include',\n        });\n\n        const data = await response.json();\n\n        // If not authenticated, try to refresh the token\n        if (!data.success || data.code === 401) {\n            try {\n                const refreshResponse = await fetch(`${BACKEND_URL}/auth/browser/refresh`, {\n                    method: 'POST',\n                    headers: {\n                        'Cookie': request.headers.get('cookie') || '',\n                        'Content-Type': 'application/json',\n                    },\n                    credentials: 'include',\n                    body: JSON.stringify({}),\n                });\n\n                const refreshData = await refreshResponse.json();\n\n                // If refresh successful, forward the Set-Cookie headers to the client\n                if (refreshData.success && refreshData.code === 200) {\n                    const res = NextResponse.next();\n\n                    // Forward Set-Cookie headers from backend to client\n                    const setCookieHeaders = refreshResponse.headers.getSetCookie();\n                    if (setCookieHeaders && setCookieHeaders.length > 0) {\n                        setCookieHeaders.forEach(cookie => {\n                            // Parse the cookie to extract name, value, and attributes\n                            const [nameValue, ...attributes] = cookie.split(';').map(s => s.trim());\n                            const [name, value] = nameValue.split('=');\n\n                            // Set the cookie on the response\n                            res.headers.append('Set-Cookie', cookie);\n                        });\n                    }\n\n                    return res;\n                }\n            } catch (refreshError) {\n                console.error('Token refresh failed:', refreshError);\n            }\n\n            // If refresh failed or was unsuccessful, redirect to signin\n            const signInUrl = new URL('/auth/signin', request.url);\n            signInUrl.searchParams.set('callbackUrl', pathname);\n            return NextResponse.redirect(signInUrl);\n        }\n\n        // User is authenticated, store user data in cookies for client-side access\n        const user = data.data?.user;\n        if (user) {\n            const res = NextResponse.next();\n\n            // Store user data in cookies (accessible by client components)\n            res.cookies.set('user-id', user.id, {\n                httpOnly: false, // Allow client-side access\n                secure: process.env.NODE_ENV === 'production',\n                sameSite: 'lax',\n                maxAge: 60 * 60 * 24 * 7, // 7 days\n            });\n\n            if (user.name) {\n                res.cookies.set('user-name', user.name, {\n                    httpOnly: false,\n                    secure: process.env.NODE_ENV === 'production',\n                    sameSite: 'lax',\n                    maxAge: 60 * 60 * 24 * 7,\n                });\n            }\n\n            if (user.email) {\n                res.cookies.set('user-email', user.email, {\n                    httpOnly: false,\n                    secure: process.env.NODE_ENV === 'production',\n                    sameSite: 'lax',\n                    maxAge: 60 * 60 * 24 * 7,\n                });\n            }\n\n            if (user.imageUrl) {\n                res.cookies.set('user-image', user.imageUrl, {\n                    httpOnly: false,\n                    secure: process.env.NODE_ENV === 'production',\n                    sameSite: 'lax',\n                    maxAge: 60 * 60 * 24 * 7,\n                });\n            }\n\n            return res;\n        }\n\n        return NextResponse.next();\n    } catch (error) {\n        console.error('Auth check failed:', error);\n        // On error, redirect to signin\n        const signInUrl = new URL('/auth/signin', request.url);\n        signInUrl.searchParams.set('callbackUrl', pathname);\n        return NextResponse.redirect(signInUrl);\n    }\n}\n\nexport const config = {\n    matcher: [\n        /*\n         * Match all request paths except for the ones starting with:\n         * - _next/static (static files)\n         * - _next/image (image optimization files)\n         * - favicon.ico (favicon file)\n         * - public files (public folder)\n         */\n        '/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',\n    ],\n};\n"],"names":[],"mappings":"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"}}]
}